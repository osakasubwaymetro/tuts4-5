<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>çµ±è¨ˆæƒ…å ± | tuts4 â€” ãƒ•ãƒ«ç‰ˆ</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* index ã¨æƒãˆãŸãƒ˜ãƒƒãƒ€ãƒ¼å«ã‚€ã‚¹ã‚¿ã‚¤ãƒ« */
  body {
    font-family: "Hiragino Sans","Segoe UI",sans-serif;
    background:#F7F8FA;
    margin:0;
    padding:0;
    color:#222;
  }

  /* NAV MENU */
  .nav-header {
    background-color: #004C97;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 16px;
    height: 54px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    position: sticky;
    top: 0;
    z-index: 9999;
  }
  .nav-title {
    font-weight: bold;
    font-size: 15px;
    letter-spacing: 0.05em;
    color: white;
  }
  .nav-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  #navUsernameDisplay {
    font-weight: bold;
    font-size: 13px;
    color: #FFD700;
  }
  .nav-menu-btn {
    background: white;
    border: none;
    color: #004C97;
    font-size: 20px;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s;
    line-height: 1;
  }
  .nav-menu-btn:hover { background: #E60012; color: white; }
  .nav-dropdown {
    position: fixed;
    top: 54px;
    right: 16px;
    background: white;
    border-radius: 14px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    min-width: 220px;
    padding: 10px 0;
    z-index: 9998;
    transform: translateY(-8px) scale(0.97);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.18s ease, transform 0.18s ease;
  }
  .nav-dropdown.open {
    opacity: 1;
    pointer-events: all;
    transform: translateY(0) scale(1);
  }
  .nav-dropdown a, .nav-dropdown button.nav-logout {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 20px;
    font-size: 14px;
    color: #222;
    text-decoration: none;
    background: none;
    border: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    font-family: inherit;
    transition: background 0.15s;
  }
  .nav-dropdown a:hover, .nav-dropdown button.nav-logout:hover {
    background: #F0F4FA;
  }
  .nav-dropdown a.active-page {
    color: #004C97;
    font-weight: bold;
    background: #EEF4FF;
  }
  .nav-dropdown .nav-divider {
    height: 1px;
    background: #eee;
    margin: 6px 0;
  }
  .nav-dropdown .nav-user-row {
    padding: 10px 20px 8px;
    font-size: 12px;
    color: #999;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .nav-dropdown .nav-user-name {
    font-weight: bold;
    color: #004C97;
    font-size: 14px;
  }
  .nav-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 9997;
  }
  .nav-backdrop.open { display: block; }

  header {
    background-color: #004C97; /* ãƒŸãƒ£ã‚¯ãƒŸãƒ£ã‚¯ãƒ–ãƒ«ãƒ¼ */
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .header-left, .header-right {
    display:flex;
    align-items:center;
    gap:10px;
  }
  header a {
    color:#E60012;
    background:white;
    text-decoration:none;
    font-size:14px;
    padding:6px 10px;
    border-radius:6px;
    transition:0.2s;
  }
  header a:hover { background-color:#E60012; color:white; }

  #usernameDisplay { font-weight:bold; font-size:14px; color:#FFD700; }

  main {
    max-width:1100px;
    margin: 20px auto;
    padding: 18px;
  }

  h1 { color:#004C97; margin:8px 0 4px 0; font-size:20px; }
  p.lead { color:#666; margin:0 0 12px 0; }

  .wrap { display:grid; gap:14px; grid-template-columns: 1fr; padding-bottom:40px; }

  .card {
    background:#fff;
    border-radius:12px;
    padding:14px;
    box-shadow:0 4px 12px rgba(0,0,0,0.06);
  }

  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .stat { font-size:20px; font-weight:600; color:#004C97 }
  .small { font-size:13px; color:#666 }

  .chart-wrap { height:300px }
  canvas { width:100% !important; height:300px !important }

  table { width:100%; border-collapse:collapse; font-size:14px; }
  th,td { padding:6px 8px; text-align:left; border-bottom:1px solid #eee; }
  th { background:#fafafa; font-weight:700; color:#333; }

  .heat-small { display:flex; gap:6px; align-items:center; font-size:13px; color:#666; margin-bottom:6px; }
  .back-btn { display:inline-block; margin-top:10px; background:#004C97;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none }

  @media (max-width:900px) {
    .grid-2 { grid-template-columns: 1fr; }
    canvas { height:260px !important; }
  }
</style>
</head>
<body>

<header class="nav-header">
  <div class="nav-title">çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
  <div class="nav-right">
    <span id="navUsernameDisplay"></span>
    <button class="nav-menu-btn" onclick="toggleNavMenu()" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼">â˜°</button>
  </div>
</header>

<div class="nav-backdrop" id="navBackdrop" onclick="closeNavMenu()"></div>
<div class="nav-dropdown" id="navDropdown">
  <div class="nav-user-row">
    ğŸ‘¤ <span class="nav-user-name" id="navMenuUsername"></span> ã•ã‚“
  </div>
  <div class="nav-divider"></div>
  <a href="index.html" >ğŸ“ æ–°è¦æŠ•ç¨¿</a>
  <a href="show.html" >ğŸ“œ æŠ•ç¨¿å±¥æ­´</a>
  <a href="statistick.html" class="active-page">ğŸ“Š çµ±è¨ˆæƒ…å ±</a>
  <a href="stampbook.html" >ğŸ« ã‚¹ã‚¿ãƒ³ãƒ—å¸³</a>
  <div class="nav-divider"></div>
  <button class="nav-logout" onclick="logout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>

<script>
function toggleNavMenu() {
  document.getElementById("navDropdown").classList.toggle("open");
  document.getElementById("navBackdrop").classList.toggle("open");
}
function closeNavMenu() {
  document.getElementById("navDropdown").classList.remove("open");
  document.getElementById("navBackdrop").classList.remove("open");
}
(function() {
  const u = localStorage.getItem("username") || "";
  if (u) {
    const d1 = document.getElementById("navUsernameDisplay");
    const d2 = document.getElementById("navMenuUsername");
    if (d1) d1.textContent = u;
    if (d2) d2.textContent = u;
  }
})();
</script>

<main>
  <h1>ğŸ“Š ã‚ãªãŸã®ä¹—è»Šçµ±è¨ˆï¼ˆãƒ•ãƒ«ç‰ˆï¼‰</h1>
  <p class="lead">ã‚ãªãŸãŒæŠ•ç¨¿ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦å„ç¨®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»ã‚°ãƒ©ãƒ•ãƒ»ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>

  <div class="wrap">

    <!-- æ¦‚è¦ -->
    <div class="card" id="overview">
      <div style="display:flex;gap:20px;flex-wrap:wrap">
        <div>
          <div class="stat" id="totalCount">0</div>
          <div class="small">ç·æŠ•ç¨¿æ•°</div>
        </div>

        <div>
          <div class="stat" id="topRoute">â€”</div>
          <div class="small">æœ€å¤šè·¯ç·š</div>
        </div>

        <div>
          <div class="stat" id="topDest">â€”</div>
          <div class="small">æœ€å¤šè¡Œå…ˆ</div>
        </div>

        <div>
          <div class="stat" id="topModel">â€”</div>
          <div class="small">æœ€å¤šè»Šä¸¡å½¢å¼</div>
        </div>
      </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div class="card grid-2">
      <div>
        <h3>è·¯ç·šãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <div id="routeList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
      </div>
      <div>
        <h3>é§…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¹—è»Šé§…ï¼‰</h3>
        <div id="stationList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
      </div>
    </div>

    <!-- æ™‚é–“å¸¯ã¨æ›œæ—¥ -->
    <div class="card grid-2">
      <div>
        <h3>æ™‚é–“å¸¯å‰²åˆï¼ˆæ—©æœ/æœ/æ˜¼/å¤•æ–¹/å¤œ/æ·±å¤œï¼‰</h3>
        <div class="chart-wrap"><canvas id="timeChart"></canvas></div>
      </div>
      <div>
        <h3>æ›œæ—¥ã”ã¨ã®åˆ©ç”¨é »åº¦</h3>
        <div class="chart-wrap"><canvas id="weekdayChart"></canvas></div>
      </div>
    </div>

    <!-- ä¼šç¤¾ãƒ»å½¢å¼ -->
    <div class="card grid-2">
      <div>
        <h3>ä¼šç¤¾åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <div id="companyList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
      </div>
      <div>
        <h3>è»Šä¸¡å½¢å¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <div id="modelList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
      </div>
    </div>

    <!-- æœˆåˆ¥æ¨ç§» -->
    <div class="card">
      <h3>æœˆåˆ¥æŠ•ç¨¿æ¨ç§»</h3>
      <div class="chart-wrap"><canvas id="monthlyChart"></canvas></div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
    <div class="card">
      <h3>å¹´é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ’ãƒ¼ãƒˆï¼ˆæŠ•ç¨¿æ—¥ã®å¯†åº¦ï¼‰</h3>
      <div class="heat-small"><span class="small">æ—¥ä»˜åˆ¥æŠ•ç¨¿æ•°ï¼ˆè‰²ãŒæ¿ƒã„ã»ã©å¤šã„ï¼‰</span></div>
      <div id="heatCalendar" style="display:flex;flex-direction:column;gap:6px;"></div>
    </div>

    <!-- ãƒãƒˆãƒªã‚¯ã‚¹ -->
    <div class="card">
      <h3>è»Šä¸¡å½¢å¼ Ã— è·¯ç·š ã®ç›¸æ€§ï¼ˆä»¶æ•°ãƒãƒˆãƒªã‚¯ã‚¹ï¼‰</h3>
      <div id="matrixWrap"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
    </div>

    <!-- ãƒ¬ã‚¢ä½“é¨“ãƒ»è¡Œå…ˆ -->
    <div class="card grid-2">
      <div>
        <h3>ãƒ¬ã‚¢ä½“é¨“ï¼ˆå‡ºç¾1å›ã®é …ç›®ï¼‰</h3>
        <div id="rareList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
      </div>
      <div>
        <h3>è¡Œå…ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <div id="destList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
      </div>
    </div>

    <div class="card">
      <h3>ç”Ÿãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€æ–° 20 ä»¶ï¼‰</h3>
      <div id="preview"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
    </div>

    <div style="text-align:right">
      <a class="back-btn" href="index.html">â† æˆ»ã‚‹</a>
    </div>

  </div>
</main>

<script>
/* ==========================
   è¨­å®šï¼šã“ã“ã‚’å¿…ãšç¢ºèªã—ã¦ç½®ãæ›ãˆã¦ãã ã•ã„
   ========================== */
/* ã‚ãªãŸã® GAS ã®å…¬é–‹ URL ã‚’ã“ã“ã«å…¥ã‚Œã¦ãã ã•ã„ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ JSON ã§è¿”ã™ã‚‚ã®ï¼‰ */
const GAS_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjpe1sdvDkmU92PLELfU1Z6qGpkz3JtNzZMWQ5iZ79DE7Qwur0fbT5slCeCmWRosaBka8Eb4ywmBoVXpTHgpNp7UDqWLeTcej8TJTHn_weTFxVNyU20A8NwFwn3qBQOjxriuJeNDvooL6ZyjaahhF0LHthfOsPkDrszUpzMOQG7CXLz-80GQV1_yJoNdqKf8ESkiCm1uGwenkXBbjez9OvKe7BxISLzvazxu5ZrOAKxcGwV30ubCJG-dgmOCsaYXgmfAtyNOkiF1ZfRLDgoxhbGayrm8w&lib=MRswRzEmnRmsQ67EMIpHjkR6HlHeBI2fu"; // ä¾‹: https://script.google.com/macros/s/XXXXX/exec";

/* ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆlocalStorage ã®ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ãã ã•ã„ï¼‰ */
const MY_NAME = localStorage.getItem("username");



/* ==========================
   ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼åãŒã°ã‚‰ã¤ã„ã¦ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ï¼‰
   ========================== */
const FIELD_KEYS = {
  username: ["ãƒ¦ãƒ¼ã‚¶ãƒ¼å","ã‚³ãƒ¼ã‚¶ãƒ¼å","åå‰","username","user","ãƒ¦ãƒ¼ã‚¶ãƒ¼","åå‰ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼‰"],
  time: ["æ™‚åˆ»","æ—¥æ™‚","date","time","timestamp","ç™ºè»Šæ™‚åˆ»","æ—¥ä»˜","departing_time"],
  route: ["è·¯ç·š","è·¯ç·šå","route"],
  station: ["ä¹—è»Šé§…","é§…å","é§…","station"],
  dest: ["è¡Œå…ˆ","Destination","è¡Œãå…ˆ","ç€","bound"],
  company: ["ä¼šç¤¾","ä¼šç¤¾å"],
  model: ["è»Šä¸¡å½¢å¼","å½¢å¼","ç·¨æˆ","è»Šä¸¡"],
  type: ["åŒºåˆ†","ç¨®åˆ¥"]
};

function pickField(obj, candidates) {
  for (const k of candidates) {
    if (obj.hasOwnProperty(k)) return obj[k];
  }
  return "";
}
function parseDateFlexible(str) {
  if (!str) return null;
  if (str instanceof Date) return str;
  const s = String(str).trim();
  let t = s.replace(/\//g,"-").replace(/å¹´|æœˆ/g,"-").replace(/æ—¥/g,"").replace("T"," ").trim();
  const tryIso = new Date(t);
  if (!isNaN(tryIso.getTime())) return tryIso;
  const alt = Date.parse(s);
  if (!isNaN(alt)) return new Date(alt);
  return null;
}
function heatColor(value, max) {
  if (max === 0) return "#f0f0f0";
  const ratio = value / max;
  const r = Math.floor(255 * ratio);
  const g = Math.floor(240 - 120 * ratio);
  const b = Math.floor(230 - 200 * ratio);
  return `rgb(${r},${g},${b})`;
}

/* ==========================
   ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»æ­£è¦åŒ–
   ========================== */
async function fetchAllData() {
  const res = await fetch(GAS_URL);
  if (!res.ok) throw new Error("GAS fetch failed: " + res.status);
  const j = await res.json();
  return j;
}
function normalizeRow(row) {
  const obj = {};
  obj.username = pickField(row, FIELD_KEYS.username);
  obj.timeRaw = pickField(row, FIELD_KEYS.time);
  obj.time = parseDateFlexible(obj.timeRaw);
  obj.route = pickField(row, FIELD_KEYS.route);
  obj.station = pickField(row, FIELD_KEYS.station);
  obj.dest = pickField(row, FIELD_KEYS.dest);
  obj.company = pickField(row, FIELD_KEYS.company);
  obj.model = pickField(row, FIELD_KEYS.model);
  obj.type = pickField(row, FIELD_KEYS.type);
  obj.raw = row;
  return obj;
}

/* ==========================
   é›†è¨ˆãƒ»è¡¨ç¤º
   ========================== */
async function buildStats() {
  // guard
  if (!MY_NAME) {
    alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
    location.href = "login.html";
    return;
  }

  // fetch & normalize
  const all = await fetchAllData();
  const norm = all.map(normalizeRow);
  const mine = norm.filter(r => String(r.username) === String(MY_NAME));

  if (!mine || mine.length === 0) {
    document.querySelector(".wrap").innerHTML = '<div class="card"><p class="small">ã‚ãªãŸã®æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p></div>';
    return;
  }

  // total
  document.getElementById("totalCount").innerText = mine.length;

  // counts
  const countBy = (arr, keyFn) => {
    const m = {};
    arr.forEach(it => {
      const k = keyFn(it) || "ï¼ˆä¸æ˜ï¼‰";
      m[k] = (m[k] || 0) + 1;
    });
    return Object.entries(m).sort((a,b)=>b[1]-a[1]);
  };

  const sortedRoutes = countBy(mine, r=>r.route);
  const sortedStations = countBy(mine, r=>r.station);
  const sortedDest = countBy(mine, r=>r.dest);
  const sortedModel = countBy(mine, r=>r.model);
  const sortedCompany = countBy(mine, r=>r.company);

  document.getElementById("topRoute").innerText = sortedRoutes[0] ? `${sortedRoutes[0][0]} (${sortedRoutes[0][1]}å›)` : "â€”";
  document.getElementById("topDest").innerText = sortedDest[0] ? `${sortedDest[0][0]} (${sortedDest[0][1]}å›)` : "â€”";
  document.getElementById("topModel").innerText = sortedModel[0] ? `${sortedModel[0][0]} (${sortedModel[0][1]}å›)` : "â€”";

  function renderList(containerId, entries) {
    const wrap = document.getElementById(containerId);
    const top = entries.slice(0,10);
    const tbl = document.createElement("table");
    const h = document.createElement("thead");
    h.innerHTML = "<tr><th>é †ä½</th><th>é …ç›®</th><th>å›æ•°</th></tr>";
    tbl.appendChild(h);
    const b = document.createElement("tbody");
    top.forEach((it,i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${it[0]}</td><td>${it[1]}</td>`;
      b.appendChild(tr);
    });
    tbl.appendChild(b);
    wrap.innerHTML = "";
    wrap.appendChild(tbl);
  }

  renderList("routeList", sortedRoutes);
  renderList("stationList", sortedStations);
  renderList("destList", sortedDest);
  renderList("companyList", sortedCompany);
  renderList("modelList", sortedModel);

  // æ™‚é–“å¸¯ buckets
  const buckets = { "æ—©æœ":0, "æœ":0, "æ˜¼":0, "å¤•æ–¹":0, "å¤œ":0, "æ·±å¤œ":0 };
  mine.forEach(r=>{
    if (!r.time) return;
    const h = r.time.getHours();
    if (h < 5) buckets["æ·±å¤œ"]++;
    else if (h < 9) buckets["æœ"]++;
    else if (h < 12) buckets["æ˜¼"]++;
    else if (h < 17) buckets["æ˜¼"]++;
    else if (h < 20) buckets["å¤•æ–¹"]++;
    else buckets["å¤œ"]++;
  });

  // weekday
  const weekdays = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  const weekdayCount = [0,0,0,0,0,0,0];
  mine.forEach(r=>{ if (r.time) weekdayCount[r.time.getDay()]++; });

  // monthly trend
  const monthMap = {};
  mine.forEach(r=>{
    if (!r.time) return;
    const key = `${r.time.getFullYear()}-${String(r.time.getMonth()+1).padStart(2,"0")}`;
    monthMap[key] = (monthMap[key]||0)+1;
  });
  const months = Object.keys(monthMap).sort();
  const monthCounts = months.map(m=>monthMap[m]);

  // charts
  const timeCtx = document.getElementById("timeChart").getContext("2d");
  new Chart(timeCtx, {
    type: 'pie',
    data: {
      labels: Object.keys(buckets),
      datasets: [{ data: Object.values(buckets), backgroundColor: ["#FFB4A2","#FFD166","#90E0EF","#A0C4FF","#BDB2FF","#E9C46A"] }]
    },
    options: { plugins:{legend:{position:'bottom'}} }
  });

  const weekdayCtx = document.getElementById("weekdayChart").getContext("2d");
  new Chart(weekdayCtx, {
    type:'bar',
    data:{ labels:weekdays, datasets:[{ label:'æŠ•ç¨¿æ•°', data:weekdayCount, backgroundColor:'#4CC9F0' }]},
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  const monthlyCtx = document.getElementById("monthlyChart").getContext("2d");
  new Chart(monthlyCtx, {
    type:'line',
    data:{ labels: months, datasets:[{ label:'æŠ•ç¨¿æ•°', data: monthCounts, fill:true, backgroundColor:'rgba(4,120,255,0.12)', borderColor:'#007bff' }]},
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  // calendar heatmap (last 365 days)
  const datesCount = {};
  mine.forEach(r => {
    if (!r.time) return;
    const key = r.time.toISOString().slice(0,10);
    datesCount[key] = (datesCount[key]||0)+1;
  });
  const today = new Date();
  const start = new Date(today);
  start.setDate(start.getDate() - 364);
  const days = [];
  let maxDayCount = 0;
  for (let d = new Date(start); d <= today; d.setDate(d.getDate()+1)) {
    const key = d.toISOString().slice(0,10);
    const c = datesCount[key] || 0;
    days.push({ key, count:c, date: new Date(d) });
    if (c > maxDayCount) maxDayCount = c;
  }

  // render heatCalendar in month blocks
  const heatWrap = document.getElementById("heatCalendar");
  heatWrap.innerHTML = "";
  const monthGroups = {};
  days.forEach(d => {
    const mKey = `${d.date.getFullYear()}-${String(d.date.getMonth()+1).padStart(2,"0")}`;
    (monthGroups[mKey] = monthGroups[mKey]||[]).push(d);
  });
  Object.keys(monthGroups).forEach(mKey => {
    const monthRows = monthGroups[mKey];
    const monthCard = document.createElement("div");
    monthCard.style.display = "flex";
    monthCard.style.alignItems = "center";
    monthCard.style.gap = "8px";
    const monthLabel = document.createElement("div");
    monthLabel.style.minWidth = "100px";
    monthLabel.style.fontSize = "13px";
    monthLabel.style.color = "#333";
    monthLabel.innerText = mKey;
    const daysWrap = document.createElement("div");
    daysWrap.style.display = "flex";
    daysWrap.style.gap = "4px";
    monthRows.forEach(day => {
      const cell = document.createElement("div");
      const color = heatColor(day.count, maxDayCount);
      cell.style.width = "14px";
      cell.style.height = "14px";
      cell.style.background = color;
      cell.title = `${day.key}ï¼š${day.count} å›`;
      cell.style.borderRadius = "3px";
      daysWrap.appendChild(cell);
    });
    monthCard.appendChild(monthLabel);
    monthCard.appendChild(daysWrap);
    heatWrap.appendChild(monthCard);
  });

  // matrix model x route
  const matrix = {};
  const models = new Set();
  const routesSet = new Set();
  mine.forEach(r => {
    const m = r.model || "ï¼ˆä¸æ˜ï¼‰";
    const ro = r.route || "ï¼ˆä¸æ˜ï¼‰";
    models.add(m); routesSet.add(ro);
    matrix[m] = matrix[m] || {};
    matrix[m][ro] = (matrix[m][ro]||0) + 1;
  });
  const modelsArr = Array.from(models).sort();
  const routesArr = Array.from(routesSet).sort();

  const matrixWrap = document.getElementById("matrixWrap");
  const tbl = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  trh.innerHTML = `<th>å½¢å¼ \\ è·¯ç·š</th>` + routesArr.map(r=>`<th>${r}</th>`).join("");
  thead.appendChild(trh);
  tbl.appendChild(thead);
  const tbody = document.createElement("tbody");
  modelsArr.forEach(m=> {
    const tr = document.createElement("tr");
    let rowHtml = `<td>${m}</td>`;
    routesArr.forEach(ro=>{
      const v = matrix[m] && matrix[m][ro] ? matrix[m][ro] : 0;
      rowHtml += `<td>${v}</td>`;
    });
    tr.innerHTML = rowHtml;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  matrixWrap.innerHTML = "";
  matrixWrap.appendChild(tbl);

  // rare items (count == 1)
  const routeCount = Object.fromEntries(sortedRoutes);
  const stationCount = Object.fromEntries(sortedStations);
  const modelCount = Object.fromEntries(sortedModel);
  const destCount = Object.fromEntries(sortedDest);
  const rare = { route:[], station:[], model:[], dest:[] };
  Object.entries(routeCount).forEach(([k,v])=>{ if (v===1) rare.route.push(k) });
  Object.entries(stationCount).forEach(([k,v])=>{ if (v===1) rare.station.push(k) });
  Object.entries(modelCount).forEach(([k,v])=>{ if (v===1) rare.model.push(k) });
  Object.entries(destCount).forEach(([k,v])=>{ if (v===1) rare.dest.push(k) });

  const rareWrap = document.getElementById("rareList");
  rareWrap.innerHTML = `<div class="small"><b>è·¯ç·šï¼ˆ1å›ã®ã¿ï¼‰:</b> ${rare.route.join(", ") || "ãªã—"}</div>
                       <div class="small"><b>é§…ï¼ˆ1å›ã®ã¿ï¼‰:</b> ${rare.station.join(", ") || "ãªã—"}</div>
                       <div class="small"><b>å½¢å¼ï¼ˆ1å›ã®ã¿ï¼‰:</b> ${rare.model.join(", ") || "ãªã—"}</div>
                       <div class="small"><b>è¡Œå…ˆï¼ˆ1å›ã®ã¿ï¼‰:</b> ${rare.dest.join(", ") || "ãªã—"}</div>`;

  // preview latest 20
  const previewWrap = document.getElementById("preview");
  const previewTbl = document.createElement("table");
  const ph = document.createElement("thead");
  // choose columns present in raw (try common ones)
  const rawKeys = Object.keys(mine[0].raw);
  const candidateHeaders = ["ç™ºè»Šæ™‚åˆ»","æ™‚åˆ»","æ—¥æ™‚","è·¯ç·š","ä¹—è»Šé§…","è¡Œå…ˆ","è»Šä¸¡å½¢å¼","ä¼šç¤¾","ãƒ¡ãƒ¢","ãƒ¦ãƒ¼ã‚¶ãƒ¼å"];
  const headerKeys = candidateHeaders.filter(k=>rawKeys.includes(k)).slice(0,6);
  const finalHeaders = headerKeys.length ? headerKeys : rawKeys.slice(0,6);
  ph.innerHTML = "<tr>" + finalHeaders.map(h=>`<th>${h}</th>`).join("") + "</tr>";
  previewTbl.appendChild(ph);
  const pb = document.createElement("tbody");
  const latest = mine.slice(-20).reverse();
  latest.forEach(r=> {
    const tr = document.createElement("tr");
    const cols = finalHeaders.map(k=>`<td>${(r.raw[k] !== undefined && r.raw[k] !== null) ? r.raw[k] : ""}</td>`).join("");
    tr.innerHTML = cols;
    pb.appendChild(tr);
  });
  previewTbl.appendChild(pb);
  previewWrap.innerHTML = "";
  previewWrap.appendChild(previewTbl);

  console.log("çµ±è¨ˆç”Ÿæˆå®Œäº†");
}

/* start */
buildStats().catch(err=>{
  console.error(err);
  document.querySelector(".wrap").innerHTML = '<div class="card"><p class="small">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p></div>';
});
</script>
</body>
</html>
