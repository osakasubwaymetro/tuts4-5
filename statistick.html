<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>çµ±è¨ˆæƒ…å ± | tuts4 â€” ãƒ•ãƒ«ç‰ˆ</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family:"Hiragino Sans","Segoe UI",sans-serif; background:#F7F8FA; margin:0; padding:18px; color:#222 }
  header { text-align:center; margin-bottom:18px }
  h1 { color:#004C97; margin:0 0 6px 0 }
  p.lead { margin:0 0 18px 0; color:#666 }

  .wrap { max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr; gap:18px; }
  .card { background:#fff; border-radius:12px; padding:14px; box-shadow:0 4px 12px rgba(0,0,0,0.06) }

  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .stat { font-size:20px; font-weight:600; color:#004C97 }
  .sub { color:#666; font-size:13px }

  .chart-wrap { height:300px }
  canvas { width:100% !important; height:300px !important }

  table { width:100%; border-collapse:collapse; }
  th,td { padding:6px 8px; text-align:left; border-bottom:1px solid #eee; font-size:14px }
  th { background:#fafafa; color:#333; font-weight:700 }

  .heat-grid { display:grid; gap:2px; grid-template-columns: repeat(31, 1fr); }
  .heat-cell { width:100%; padding-top:100%; position:relative; border-radius:4px; }
  .heat-cell > span { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:11px; color:rgba(0,0,0,0.6) }

  .small { font-size:13px; color:#666 }
  .back { display:inline-block; margin-top:10px; background:#004C97;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap }
  @media (max-width:900px){ .grid-2{ grid-template-columns: 1fr } canvas{ height:260px !important } .heat-grid{ grid-template-columns: repeat(14,1fr) } }
</style>
</head>
<body>

<header>
  <h1>ğŸ“Š ã‚ãªãŸã®ä¹—è»Šçµ±è¨ˆï¼ˆãƒ•ãƒ«ç‰ˆï¼‰</h1>
  <p class="lead">ã‚ãªãŸãŒæŠ•ç¨¿ã—ãŸãƒ‡ãƒ¼ã‚¿ã ã‘ã‚’ä½¿ã£ã¦å„ç¨®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ»ã‚°ãƒ©ãƒ•ãƒ»ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
</header>

<div class="wrap">

  <!-- æ¦‚è¦ -->
  <div class="card" id="overview">
    <div class="row">
      <div>
        <div class="stat" id="totalCount">0</div>
        <div class="small">ç·æŠ•ç¨¿æ•°</div>
      </div>

      <div>
        <div class="stat" id="topRoute">â€”</div>
        <div class="small">æœ€å¤šè·¯ç·š</div>
      </div>

      <div>
        <div class="stat" id="topDest">â€”</div>
        <div class="small">æœ€å¤šè¡Œå…ˆ</div>
      </div>

      <div>
        <div class="stat" id="topModel">â€”</div>
        <div class="small">æœ€å¤šè»Šä¸¡å½¢å¼</div>
      </div>
    </div>
  </div>

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
  <div class="card grid-2">
    <div>
      <h3>è·¯ç·šãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
      <div id="routeList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
    </div>
    <div>
      <h3>é§…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¹—è»Šé§…ï¼‰</h3>
      <div id="stationList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
    </div>
  </div>

  <!-- æ™‚é–“å¸¯ã¨æ›œæ—¥ -->
  <div class="card grid-2">
    <div>
      <h3>æ™‚é–“å¸¯å‰²åˆï¼ˆæœ/æ˜¼/å¤•/å¤œï¼‰</h3>
      <div class="chart-wrap"><canvas id="timeChart"></canvas></div>
    </div>
    <div>
      <h3>æ›œæ—¥ã”ã¨ã®åˆ©ç”¨é »åº¦</h3>
      <div class="chart-wrap"><canvas id="weekdayChart"></canvas></div>
    </div>
  </div>

  <!-- ä¼šç¤¾ãƒ»å½¢å¼ -->
  <div class="card grid-2">
    <div>
      <h3>ä¼šç¤¾åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
      <div id="companyList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
    </div>
    <div>
      <h3>è»Šä¸¡å½¢å¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
      <div id="modelList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
    </div>
  </div>

  <!-- æœˆåˆ¥æ¨ç§»ã¨æ›œæ—¥ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
  <div class="card">
    <h3>æœˆåˆ¥æŠ•ç¨¿æ¨ç§»</h3>
    <div class="chart-wrap"><canvas id="monthlyChart"></canvas></div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
  <div class="card">
    <h3>å¹´é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ’ãƒ¼ãƒˆï¼ˆæŠ•ç¨¿æ—¥ã®å¯†åº¦ï¼‰</h3>
    <div id="heatDesc" class="small">æ—¥ä»˜åˆ¥æŠ•ç¨¿æ•°ï¼ˆè‰²ãŒæ¿ƒã„ã»ã©å¤šã„ï¼‰</div>
    <div id="heatCalendar" style="margin-top:8px;"></div>
  </div>

  <!-- å½¢å¼Ã—è·¯ç·šè¡Œåˆ— -->
  <div class="card">
    <h3>è»Šä¸¡å½¢å¼ Ã— è·¯ç·š ã®ç›¸æ€§ï¼ˆä»¶æ•°ãƒãƒˆãƒªã‚¯ã‚¹ï¼‰</h3>
    <div id="matrixWrap"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
  </div>

  <!-- ãƒ¬ã‚¢ä½“é¨“ãƒ»ãã®ä»– -->
  <div class="card grid-2">
    <div>
      <h3>ãƒ¬ã‚¢ä½“é¨“ï¼ˆå‡ºç¾1å›ã®é …ç›®ï¼‰</h3>
      <div id="rareList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
    </div>
    <div>
      <h3>è¡Œå…ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
      <div id="destList"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
    </div>
  </div>

  <div class="card">
    <h3>ç”Ÿãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæœ€æ–° 20 ä»¶ï¼‰</h3>
    <div id="preview"><p class="small">èª­ã¿è¾¼ã¿ä¸­â€¦</p></div>
  </div>

  <a class="back" href="index.html">â† æˆ»ã‚‹</a>
</div>

<script>
/* ==========================
   è¨­å®šï¼ˆå¿…ãšç¢ºèªï¼‰
   ========================== */

/* ã‚ãªãŸã® GAS ã®å…¬é–‹ URL ã‚’ã“ã“ã«å…¥ã‚Œã¦ãã ã•ã„ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ JSON ã§è¿”ã™ã‚‚ã®ï¼‰ */
const GAS_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLjpe1sdvDkmU92PLELfU1Z6qGpkz3JtNzZMWQ5iZ79DE7Qwur0fbT5slCeCmWRosaBka8Eb4ywmBoVXpTHgpNp7UDqWLeTcej8TJTHn_weTFxVNyU20A8NwFwn3qBQOjxriuJeNDvooL6ZyjaahhF0LHthfOsPkDrszUpzMOQG7CXLz-80GQV1_yJoNdqKf8ESkiCm1uGwenkXBbjez9OvKe7BxISLzvazxu5ZrOAKxcGwV30ubCJG-dgmOCsaYXgmfAtyNOkiF1ZfRLDgoxhbGayrm8w&lib=MRswRzEmnRmsQ67EMIpHjkR6HlHeBI2fu"; // ä¾‹: https://script.google.com/macros/s/XXXXX/exec

/* ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆlocalStorage ã®ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ãã ã•ã„ï¼‰ */
const MY_NAME = localStorage.getItem("username"); // æ—¢å­˜ã® login.html ã«åˆã‚ã›ã¦ã„ã‚‹æƒ³å®š

if (!MY_NAME) {
  alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
  location.href = "login.html";
}

/* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®åˆ—åï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚’è¤‡æ•°å€™è£œã§æŒ‡å®šã—ã¦ãŠãï¼ˆè‡ªç”±ã«è¿½åŠ å¯ï¼‰ */
const FIELD_KEYS = {
  username: ["ãƒ¦ãƒ¼ã‚¶ãƒ¼å","ã‚³ãƒ¼ã‚¶ãƒ¼å","åå‰","username","user","ãƒ¦ãƒ¼ã‚¶ãƒ¼"],   // æŠ•ç¨¿è€…
  time: ["æ™‚åˆ»","æ—¥æ™‚","date","time","timestamp"],
  route: ["è·¯ç·š","è·¯ç·šå","route"],
  station: ["ä¹—è»Šé§…","é§…å","é§…","station"],
  dest: ["è¡Œå…ˆ","Destination","è¡Œãå…ˆ","ç€"],
  company: ["ä¼šç¤¾","ä¼šç¤¾å"],
  model: ["è»Šä¸¡å½¢å¼","å½¢å¼","ç·¨æˆ","è»Šä¸¡"],
  type: ["åŒºåˆ†","ç¨®åˆ¥"]
};

/* ==========================
   ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ========================== */

function pickField(obj, candidates) {
  for (const k of candidates) {
    if (obj.hasOwnProperty(k)) return obj[k];
  }
  return "";
}

function safeNum(v){ return (v===undefined||v===null||v==="")?0: Number(v) || 0; }

function parseDateFlexible(str) {
  if (!str) return null;
  if (str instanceof Date) return str;
  // ã¾ãš ISO ã£ã½ã„å¤‰æ›
  const s = String(str).trim();
  // ã„ãã¤ã‹ã®å½¢å¼ã«å¯¾å¿œï¼š "2025-10-14 7:25", "2025/10/14 07:25", "2025-10-14T07:25"
  let t = s.replace(/\//g,"-").replace(/å¹´|æœˆ/g,"-").replace(/æ—¥/g,"").replace("T"," ").trim();
  // ensure zero padded hour if needed not necessary
  const tryIso = new Date(t);
  if (!isNaN(tryIso.getTime())) return tryIso;
  // fallback Date.parse
  const alt = Date.parse(s);
  if (!isNaN(alt)) return new Date(alt);
  return null;
}

/* ã‚«ãƒ©ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆheatï¼‰ */
function heatColor(value, max) {
  if (max === 0) return "#f0f0f0";
  const ratio = value / max;
  // from very light -> deep orange
  const r = Math.floor(255 * ratio);
  const g = Math.floor(240 - 120 * ratio);
  const b = Math.floor(230 - 200 * ratio);
  return `rgb(${r},${g},${b})`;
}

/* ==========================
   ãƒ‡ãƒ¼ã‚¿å–å¾— & å‰å‡¦ç†
   ========================== */

async function fetchAllData() {
  const res = await fetch(GAS_URL);
  const j = await res.json();
  return j;
}

function normalizeRow(row) {
  // returns normalized object with canonical keys
  const obj = {};
  obj.username = pickField(row, FIELD_KEYS.username);
  obj.timeRaw = pickField(row, FIELD_KEYS.time);
  obj.time = parseDateFlexible(obj.timeRaw);
  obj.route = pickField(row, FIELD_KEYS.route);
  obj.station = pickField(row, FIELD_KEYS.station);
  obj.dest = pickField(row, FIELD_KEYS.dest);
  obj.company = pickField(row, FIELD_KEYS.company);
  obj.model = pickField(row, FIELD_KEYS.model);
  obj.type = pickField(row, FIELD_KEYS.type);
  obj.raw = row;
  return obj;
}

/* ==========================
   é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯
   ========================== */

async function buildStats() {
  const all = await fetchAllData();

  // normalize all rows
  const norm = all.map(normalizeRow);

  // filter my posts
  const mine = norm.filter(r => String(r.username) === String(MY_NAME));

  // early return if empty
  if (!mine || mine.length === 0) {
    document.getElementById("container").innerHTML = "<p>ã‚ãªãŸã®æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    return;
  }

  // total
  const total = mine.length;
  document.getElementById("totalCount").innerText = total;

  // route counts
  const routeCount = {};
  mine.forEach(r => { const k = r.route || "ï¼ˆä¸æ˜ï¼‰"; routeCount[k] = (routeCount[k]||0)+1; });

  const sortedRoutes = Object.entries(routeCount).sort((a,b)=>b[1]-a[1]);
  document.getElementById("topRoute").innerText = sortedRoutes[0] ? `${sortedRoutes[0][0]} (${sortedRoutes[0][1]}å›)` : "â€”";

  // destination counts
  const destCount = {};
  mine.forEach(r => { const k = r.dest || "ï¼ˆä¸æ˜ï¼‰"; destCount[k] = (destCount[k]||0)+1; });
  const sortedDest = Object.entries(destCount).sort((a,b)=>b[1]-a[1]);
  document.getElementById("topDest").innerText = sortedDest[0] ? `${sortedDest[0][0]} (${sortedDest[0][1]}å›)` : "â€”";

  // model counts
  const modelCount = {};
  mine.forEach(r => { const k = r.model || "ï¼ˆä¸æ˜ï¼‰"; modelCount[k] = (modelCount[k]||0)+1; });
  const sortedModel = Object.entries(modelCount).sort((a,b)=>b[1]-a[1]);
  document.getElementById("topModel").innerText = sortedModel[0] ? `${sortedModel[0][0]} (${sortedModel[0][1]}å›)` : "â€”";

  // render top lists (top 10)
  function renderList(containerId, entries) {
    const wrap = document.getElementById(containerId);
    const top = entries.slice(0,10);
    const tbl = document.createElement("table");
    const h = document.createElement("thead");
    h.innerHTML = "<tr><th>é †ä½</th><th>é …ç›®</th><th>å›æ•°</th></tr>";
    tbl.appendChild(h);
    const b = document.createElement("tbody");
    top.forEach((it,i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${it[0]}</td><td>${it[1]}</td>`;
      b.appendChild(tr);
    });
    tbl.appendChild(b);
    wrap.innerHTML = "";
    wrap.appendChild(tbl);
  }

  renderList("routeList", sortedRoutes);
  renderList("destList", sortedDest);

  // station ranking
  const stationCount = {};
  mine.forEach(r => { const k = r.station || "ï¼ˆä¸æ˜ï¼‰"; stationCount[k] = (stationCount[k]||0)+1; });
  const sortedStation = Object.entries(stationCount).sort((a,b)=>b[1]-a[1]);
  renderList("stationList", sortedStation);

  // company & model lists
  const companyCount = {};
  mine.forEach(r => { const k = r.company || "ï¼ˆä¸æ˜ï¼‰"; companyCount[k] = (companyCount[k]||0)+1; });
  const sortedCompany = Object.entries(companyCount).sort((a,b)=>b[1]-a[1]);
  renderList("companyList", sortedCompany);
  renderList("modelList", sortedModel);

  // time-of-day buckets
  const buckets = { "æ—©æœ":0, "æœ":0, "æ˜¼":0, "å¤•æ–¹":0, "å¤œ":0, "æ·±å¤œ":0 };
  mine.forEach(r=>{
    if (!r.time) return;
    const h = r.time.getHours();
    if (h < 5) buckets["æ·±å¤œ"]++;
    else if (h < 9) buckets["æœ"]++;
    else if (h < 12) buckets["æ˜¼"]++;
    else if (h < 17) buckets["æ˜¼"]++;
    else if (h < 20) buckets["å¤•æ–¹"]++;
    else if (h < 24) buckets["å¤œ"]++;
  });

  // weekday counts (0=Sun..6=Sat)
  const weekdays = [ "æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ" ];
  const weekdayCount = [0,0,0,0,0,0,0];
  mine.forEach(r => {
    if (!r.time) return;
    weekdayCount[r.time.getDay()]++;
  });

  // monthly trend (by YYYY-MM)
  const monthMap = {};
  mine.forEach(r=>{
    if (!r.time) return;
    const key = `${r.time.getFullYear()}-${String(r.time.getMonth()+1).padStart(2,"0")}`;
    monthMap[key] = (monthMap[key]||0)+1;
  });
  const months = Object.keys(monthMap).sort();
  const monthCounts = months.map(m=>monthMap[m]);

  // draw charts with Chart.js
  // timeChart
  const timeCtx = document.getElementById("timeChart").getContext("2d");
  const timeChart = new Chart(timeCtx, {
    type: 'pie',
    data: {
      labels: Object.keys(buckets),
      datasets: [{ data: Object.values(buckets), backgroundColor: ["#FFB4A2","#FFD166","#90E0EF","#A0C4FF","#BDB2FF","#E9C46A"] }]
    },
    options: { plugins:{legend:{position:'bottom'}} }
  });

  const weekdayCtx = document.getElementById("weekdayChart").getContext("2d");
  const weekdayChart = new Chart(weekdayCtx, {
    type:'bar',
    data:{ labels:weekdays, datasets:[{ label:'æŠ•ç¨¿æ•°', data:weekdayCount, backgroundColor:'#4CC9F0' }]},
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  const monthlyCtx = document.getElementById("monthlyChart").getContext("2d");
  const monthlyChart = new Chart(monthlyCtx, {
    type:'line',
    data:{ labels: months, datasets:[{ label:'æŠ•ç¨¿æ•°', data: monthCounts, fill:true, backgroundColor:'rgba(4,120,255,0.12)', borderColor:'#007bff' }]},
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });

  // calendar heatmap (simple: current year)
  const datesCount = {};
  mine.forEach(r => {
    if (!r.time) return;
    const d = new Date(r.time.getFullYear(), r.time.getMonth(), r.time.getDate());
    const key = d.toISOString().slice(0,10);
    datesCount[key] = (datesCount[key]||0)+1;
  });

  // build calendar for the last 365 days (or current year)
  const today = new Date();
  const start = new Date(today);
  start.setDate(start.getDate() - 364);
  // aggregate by date keys
  const days = [];
  let maxDayCount = 0;
  for (let d = new Date(start); d <= today; d.setDate(d.getDate()+1)) {
    const key = d.toISOString().slice(0,10);
    const c = datesCount[key] || 0;
    days.push({ key, count:c, date: new Date(d) });
    if (c > maxDayCount) maxDayCount = c;
  }

  // render heat calendar: group by month rows for simple layout
  const heatWrap = document.getElementById("heatCalendar");
  heatWrap.innerHTML = "";
  // create weekly rows visually: we'll render a simple horizontal sequence with day labels above months
  const monthsMap = {};
  days.forEach(d=> {
    const m = d.date.getMonth();
    monthsMap[m] = monthsMap[m] || [];
    monthsMap[m].push(d);
  });

  // Simple layout: months as rows of days
  Object.keys(monthsMap).forEach(m=> {
    const monthRows = monthsMap[m];
    const monthCard = document.createElement("div");
    monthCard.style.marginBottom = "8px";
    const monthLabel = document.createElement("div");
    monthLabel.style.fontSize = "13px";
    monthLabel.style.marginBottom = "6px";
    monthLabel.innerText = `${monthRows[0].date.getFullYear()}-${String(monthRows[0].date.getMonth()+1).padStart(2,"0")}`;
    monthCard.appendChild(monthLabel);
    const grid = document.createElement("div");
    grid.style.display = "flex";
    grid.style.gap = "4px";
    monthRows.forEach(day => {
      const cell = document.createElement("div");
      cell.className = "heat-cell";
      const color = heatColor(day.count, maxDayCount);
      cell.style.width = "18px";
      cell.style.height = "18px";
      cell.style.background = color;
      cell.title = `${day.key}ï¼š${day.count} å›`;
      monthCard.appendChild(cell);
    });
    heatWrap.appendChild(monthCard);
  });

  // matrix: model x route
  const matrix = {};
  const models = new Set();
  const routesSet = new Set();
  mine.forEach(r => {
    const m = r.model || "ï¼ˆä¸æ˜ï¼‰";
    const ro = r.route || "ï¼ˆä¸æ˜ï¼‰";
    models.add(m); routesSet.add(ro);
    matrix[m] = matrix[m] || {};
    matrix[m][ro] = (matrix[m][ro]||0) + 1;
  });
  const modelsArr = Array.from(models);
  const routesArr = Array.from(routesSet);

  // build table
  const matrixWrap = document.getElementById("matrixWrap");
  const tbl = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  trh.innerHTML = `<th>å½¢å¼ \\ è·¯ç·š</th>` + routesArr.map(r=>`<th>${r}</th>`).join("");
  thead.appendChild(trh);
  tbl.appendChild(thead);
  const tbody = document.createElement("tbody");
  modelsArr.forEach(m=>{
    const tr = document.createElement("tr");
    let rowHtml = `<td>${m}</td>`;
    routesArr.forEach(ro=>{
      const v = matrix[m] && matrix[m][ro] ? matrix[m][ro] : 0;
      rowHtml += `<td>${v}</td>`;
    });
    tr.innerHTML = rowHtml;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  matrixWrap.innerHTML = "";
  matrixWrap.appendChild(tbl);

  // rare items (count == 1) for route/station/model/dest
  const rare = { route:[], station:[], model:[], dest:[] };
  Object.entries(routeCount).forEach(([k,v])=>{ if (v===1) rare.route.push(k) });
  Object.entries(stationCount).forEach(([k,v])=>{ if (v===1) rare.station.push(k) });
  Object.entries(modelCount).forEach(([k,v])=>{ if (v===1) rare.model.push(k) });
  Object.entries(destCount).forEach(([k,v])=>{ if (v===1) rare.dest.push(k) });

  const rareWrap = document.getElementById("rareList");
  rareWrap.innerHTML = `<div class="small"><b>è·¯ç·šï¼ˆ1å›ã®ã¿ï¼‰:</b> ${rare.route.join(", ") || "ãªã—"}</div>
                       <div class="small"><b>é§…ï¼ˆ1å›ã®ã¿ï¼‰:</b> ${rare.station.join(", ") || "ãªã—"}</div>
                       <div class="small"><b>å½¢å¼ï¼ˆ1å›ã®ã¿ï¼‰:</b> ${rare.model.join(", ") || "ãªã—"}</div>
                       <div class="small"><b>è¡Œå…ˆï¼ˆ1å›ã®ã¿ï¼‰:</b> ${rare.dest.join(", ") || "ãªã—"}</div>`;

  // preview latest 20
  const previewWrap = document.getElementById("preview");
  const previewTbl = document.createElement("table");
  const ph = document.createElement("thead");
  // choose a few columns to show: æ™‚åˆ», è·¯ç·š, ä¹—è»Šé§…, è¡Œå…ˆ, è»Šä¸¡å½¢å¼, ãƒ¡ãƒ¢ if present in raw keys
  const rawKeys = Object.keys(mine[0].raw);
  const showKeys = ["æ™‚åˆ»","è·¯ç·š","ä¹—è»Šé§…","è¡Œå…ˆ","è»Šè»Šä¸¡å½¢å¼","è»Šä¸¡å½¢å¼","ãƒ¡ãƒ¢","ãƒ¦ãƒ¼ã‚¶ãƒ¼å"].filter(k=>rawKeys.includes(k));
  // if none matched, just use all raw keys (first 6)
  const headerKeys = showKeys.length ? showKeys.slice(0,6) : rawKeys.slice(0,6);
  ph.innerHTML = "<tr>" + headerKeys.map(h=>`<th>${h}</th>`).join("") + "</tr>";
  previewTbl.appendChild(ph);
  const pb = document.createElement("tbody");
  const latest = mine.slice(-20).reverse();
  latest.forEach(r=>{
    const tr = document.createElement("tr");
    const cols = headerKeys.map(k=>`<td>${(r.raw[k] !== undefined && r.raw[k] !== null) ? r.raw[k] : ""}</td>`).join("");
    tr.innerHTML = cols;
    pb.appendChild(tr);
  });
  previewTbl.appendChild(pb);
  previewWrap.innerHTML = "";
  previewWrap.appendChild(previewTbl);

  // set top lists displayed earlier (short)
  // routeList already rendered table; we can also keep them as is

  // finished
  console.log("çµ±è¨ˆç”Ÿæˆå®Œäº†");
}

/* start */
buildStats().catch(err=>{
  console.error(err);
  document.getElementById("container").innerHTML = "<p>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>";
});

</script>
</body>
</html>
